{% extends 'shop/base.html' %}
{% block content %}
<style>
    .material-section-title {
        font-family: 'Montserrat', Arial, sans-serif;
        font-weight: 700;
        color: #111;
        letter-spacing: 1px;
        margin: 2.5rem 0 1.5rem 0;
        font-size: 2.1rem;
        text-align: center;
    }
    .material-card {
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1.5px solid #eee;
        background: #fff;
        transition: box-shadow .2s, transform .2s;
    }
    .material-card .card-body {
        padding: 2rem 1.5rem;
    }
    @media (max-width: 600px) {
        .material-section-title {
            font-size: 1.1rem !important;
            margin: 1rem 0 0.7rem 0 !important;
        }
        .row.mb-3 {
            margin-bottom: 0.7rem !important;
        }
        .material-card {
            border-radius: 10px !important;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.07) !important;
        }
        .material-card .card-body {
            padding: 1rem 0.5rem !important;
        }
        canvas {
            width: 180px !important;
            height: 180px !important;
        }
    }
</style>
<div class="container">
    <!-- show order custom bracelet title -->
    <div class="material-section-title">Order Custom Bracelet</div>
    <!-- show back button -->
    <button type="button" class="btn btn-outline-primary mb-3" onclick="window.history.back();">Back</button>
    <div class="row mb-3">
        <!-- show design details and bead dropdown -->
        <div class="col-md-5">
            <strong>Design Name:</strong> {{ design.name }}<br>
            <label for="beadDropdown" class="form-label"><strong>Design Details:</strong></label>
            <select id="beadDropdown" class="form-select" size="8" style="max-width:320px;">
                {% for bead in design.text_form %}
                    <option>{{ bead }}</option>
                {% endfor %}
            </select>
        </div>
        <!-- show bracelet preview -->
        <div class="col-md-7 d-flex align-items-center justify-content-center">
            <div class="material-card card w-100">
                <div class="card-body d-flex align-items-center justify-content-center">
                    <canvas id="bracelet-canvas" width="400" height="400" style="border:1px solid #ccc; background:#fff; border-radius:50%;"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- show order form -->
    <form method="post" class="mt-4">
        {% csrf_token %}
        <label for="payment_type" class="form-label">Payment Type</label>
        <select name="payment_type" id="payment_type" class="form-select mb-3">
            <option value="gcash">GCash</option>
            <option value="maya">Maya</option>
        </select>
        <button type="submit" class="btn btn-primary">Place Order</button>
        <a href="{% url 'customize_bracelet' %}" class="btn btn-link">Back to Designs</a>
    </form>
</div>
<!-- show bracelet preview script -->
<script>
function isLightColor(hex) {
    if (!hex) return false;
    hex = hex.replace('#', '');
    if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
    if (hex.length !== 6) return false;
    const r = parseInt(hex.substr(0,2),16);
    const g = parseInt(hex.substr(2,2),16);
    const b = parseInt(hex.substr(4,2),16);
    const luminance = 0.299*r + 0.587*g + 0.114*b;
    return luminance > 180;
}
const beads = {{ design.beads|safe }};
const canvas = document.getElementById('bracelet-canvas');
const ctx = canvas.getContext('2d');
function drawBracelet() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const cx = canvas.width/2, cy = canvas.height/2, r = 150;
    const n = beads.length;
    for (let i=0; i<n; ++i) {
        const angle = (2*Math.PI*i)/n;
        const bx = cx + r*Math.cos(angle);
        const by = cy + r*Math.sin(angle);
        const bead = beads[i];
        ctx.save();
        ctx.translate(bx, by);
        ctx.rotate(angle + Math.PI/2);
        ctx.strokeStyle = "#888";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.fillStyle = bead.color || "#888";
        let size = bead.size === "large" ? 28 : bead.size === "medium" ? 20 : 14;
        if (bead.shape === "circle") {
            ctx.arc(0, 0, size, 0, 2*Math.PI);
            ctx.fill();
            ctx.stroke();
        } else if (bead.shape === "square") {
            ctx.rect(-size, -size, size*2, size*2);
            ctx.fill();
            ctx.stroke();
        } else if (bead.shape === "triangle") {
            ctx.moveTo(0, -size);
            ctx.lineTo(size, size);
            ctx.lineTo(-size, size);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        } else if (bead.shape === "star") {
            ctx.beginPath();
            for (let j = 0; j < 5; j++) {
                ctx.lineTo(
                    Math.cos((18 + j * 72) / 180 * Math.PI) * size,
                    -Math.sin((18 + j * 72) / 180 * Math.PI) * size
                );
                ctx.lineTo(
                    Math.cos((54 + j * 72) / 180 * Math.PI) * size * 0.5,
                    -Math.sin((54 + j * 72) / 180 * Math.PI) * size * 0.5
                );
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        } else if (bead.shape === "heart") {
            ctx.beginPath();
            ctx.moveTo(0, size/2);
            ctx.bezierCurveTo(size, -size/2, size/2, -size, 0, -size/3);
            ctx.bezierCurveTo(-size/2, -size, -size, -size/2, 0, size/2);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        } else if (bead.shape === "hexagon") {
            ctx.beginPath();
            for (let j = 0; j < 6; j++) {
                let a = Math.PI/3 * j;
                let x = Math.cos(a) * size;
                let y = Math.sin(a) * size;
                if (j === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        } else if (bead.shape === "diamond") {
            ctx.beginPath();
            ctx.moveTo(0, -size);
            ctx.lineTo(size, 0);
            ctx.lineTo(0, size);
            ctx.lineTo(-size, 0);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        }
        // Draw letter if present
        if (bead.letter) {
            ctx.save();
            ctx.font = `${size*1.2}px Arial Black,Arial,sans-serif`;
            ctx.fillStyle = isLightColor(bead.color) ? "#000" : "#fff";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(bead.letter, 0, 0);
            ctx.restore();
        }
        ctx.restore();
    }
}
drawBracelet();
</script>
{% endblock %}
