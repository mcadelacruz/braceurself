{% extends 'shop/base.html' %}
{% block content %}
<h1 class="mb-4">Seller Dashboard</h1>
<div class="row">
	<!-- Left: Analytics -->
	<div class="col-md-4 mb-4">
		<div class="card">
			<div class="card-body">
				<h5 class="card-title">Quick Analytics</h5>
				<!-- Orders Placed Line Graph -->
				<div class="mb-2">
					<label for="ordersPlacedRange" class="form-label mb-0">Orders Placed</label>
					<select id="ordersPlacedRange" class="form-select form-select-sm w-auto d-inline-block ms-2">
						<option value="today">Today</option>
						<option value="7">Last 7 days</option>
						<option value="30">Last 30 days</option>
						<option value="all">All time</option>
					</select>
				</div>
				<canvas id="ordersPlacedChart" width="400" height="120" class="mb-3"></canvas>
				<!-- Earnings Line Graph -->
				<div class="mb-2">
					<label for="earningsRange" class="form-label mb-0">Earnings</label>
					<select id="earningsRange" class="form-select form-select-sm w-auto d-inline-block ms-2">
						<option value="today">Today</option>
						<option value="7">Last 7 days</option>
						<option value="30">Last 30 days</option>
						<option value="all">All time</option>
					</select>
				</div>
				<canvas id="earningsChart" width="400" height="120" class="mb-3"></canvas>
				<!-- Completed vs Cancelled Orders Line Graph -->
				<div class="mb-2">
					<label for="completedCancelledRange" class="form-label mb-0">Completed vs Cancelled Orders</label>
					<select id="completedCancelledRange" class="form-select form-select-sm w-auto d-inline-block ms-2">
						<option value="today">Today</option>
						<option value="7">Last 7 days</option>
						<option value="30">Last 30 days</option>
						<option value="all">All time</option>
					</select>
				</div>
				<canvas id="completedCancelledChart" width="400" height="120"></canvas>

				<ul class="list-group list-group-flush mt-3">
					<li class="list-group-item">Orders Today: <strong>{{ orders_today }}</strong></li>
					<li class="list-group-item">Last 7 days: <strong>{{ orders_last_7 }}</strong></li>
					<li class="list-group-item">Last 30 days: <strong>{{ orders_last_30 }}</strong></li>
					<li class="list-group-item">Total Completed: <strong>{{ total_completed }}</strong></li>
					<li class="list-group-item">Total Cancelled: <strong>{{ total_cancelled }}</strong></li>
					<li class="list-group-item">Total Earnings: <strong>${{ total_earnings }}</strong></li>
					<li class="list-group-item">Avg Completed Order Value: <strong>${{ avg_order_value }}</strong></li>
				</ul>

				{% if top_products %}
				<div class="mt-3">
					<h6>Top Products</h6>
					<ul class="list-unstyled mb-0">
						{% for p in top_products %}
							<li>{{ forloop.counter }}. {{ p.product__name }} — {{ p.total_qty }} sold</li>
						{% endfor %}
					</ul>
				</div>
				{% endif %}
			</div>
		</div>
	</div>

	<!-- Middle: Products: Add & show 5 recent with link -->
	<div class="col-md-4 mb-4">
		<div class="card mb-3">
			<div class="card-body">
				<h5>Add Product</h5>
				<form method="post" enctype="multipart/form-data" class="mb-2">
					{% csrf_token %}
					{{ form.as_p }}
					<button type="submit" class="btn btn-success">Add Product</button>
				</form>
				<a href="{% url 'manage_products_list' %}" class="btn btn-outline-secondary w-100">Manage All Products</a>
			</div>
		</div>

		<div class="card">
			<div class="card-header">Recent Products ({{ total_products }})</div>
			<ul class="list-group list-group-flush">
				{% for product in products %}
                    {% if not product.name|slice:":7" == "Custom:" %}
					<li class="list-group-item d-flex align-items-center">
						{% if product.image %}
							<img src="{{ product.image.url }}" alt="{{ product.name }}" style="width:40px;height:40px;object-fit:cover;" class="me-2 rounded">
						{% else %}
							<div class="me-2 rounded bg-light d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
								<span class="text-muted">No image</span>
							</div>
						{% endif %}
						<div>
							<strong>{{ product.name }}</strong><br>
							<small>Price: ${{ product.price }} • Stock: {{ product.stock }}</small>
						</div>
					</li>
                    {% endif %}
				{% empty %}
					<li class="list-group-item">No products yet.</li>
				{% endfor %}
			</ul>
		</div>
	</div>

	<!-- Right: Recent Orders -->
	<div class="col-md-4 mb-4">
		<div class="card">
			<div class="card-header">Recent Orders ({{ total_orders }})</div>
			<ul class="list-group list-group-flush">
				{% for order in orders %}
					<li class="list-group-item">
						<div class="d-flex align-items-center">
							{% if order.product.image %}
								<img src="{{ order.product.image.url }}" alt="{{ order.product.name }}" style="width:40px;height:40px;object-fit:cover;" class="me-2 rounded">
							{% endif %}
							<div>
								<strong>{{ order.product.name }}</strong> (x{{ order.quantity }})<br>
								<small>Customer: {{ order.customer.username }} • {{ order.get_status_display }}</small>
							</div>
						</div>
					</li>
				{% empty %}
					<li class="list-group-item">No orders yet.</li>
				{% endfor %}
			</ul>
			<div class="card-body">
				<a href="{% url 'manage_orders_list' %}" class="btn btn-outline-secondary w-100">View All Orders</a>
			</div>
		</div>
	</div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	// Prepare all datasets from Django context
	const ordersPlacedSeries = {
		today: {{ orders_placed_today|safe }},
		'7': {{ orders_placed_7|safe }},
		'30': {{ orders_placed_30|safe }},
		all: {{ orders_placed_all|safe }},
	};
	const earningsSeries = {
		today: {{ earnings_today_series|safe }},
		'7': {{ earnings_7_series|safe }},
		'30': {{ earnings_30_series|safe }},
		all: {{ earnings_all_series|safe }},
	};
	const completedSeries = {
		today: {{ completed_today_series|safe }},
		'7': {{ completed_7_series|safe }},
		'30': {{ completed_30_series|safe }},
		all: {{ completed_all_series|safe }},
	};
	const cancelledSeries = {
		today: {{ cancelled_today_series|safe }},
		'7': {{ cancelled_7_series|safe }},
		'30': {{ cancelled_30_series|safe }},
		all: {{ cancelled_all_series|safe }},
	};

	function extractLabelsAndValues(series) {
		return {
			labels: series.map(x => x.label),
			values: series.map(x => x.value)
		};
	}

	// Orders Placed Chart
	const ordersPlacedCtx = document.getElementById('ordersPlacedChart').getContext('2d');
	let ordersPlacedData = extractLabelsAndValues(ordersPlacedSeries.today);
	const ordersPlacedChart = new Chart(ordersPlacedCtx, {
		type: 'line',
		data: {
			labels: ordersPlacedData.labels,
			datasets: [{
				label: 'Orders Placed',
				data: ordersPlacedData.values,
				fill: false,
				borderColor: '#0d6efd',
				backgroundColor: '#0d6efd',
				tension: 0.3,
				pointRadius: 4,
				pointHoverRadius: 6
			}]
		},
		options: {
			scales: { y: { beginAtZero: true, precision:0 } },
			plugins: { legend: { display: true } }
		}
	});

	document.getElementById('ordersPlacedRange').addEventListener('change', function() {
		const val = this.value;
		const data = extractLabelsAndValues(ordersPlacedSeries[val]);
		ordersPlacedChart.data.labels = data.labels;
		ordersPlacedChart.data.datasets[0].data = data.values;
		ordersPlacedChart.update();
	});

	// Earnings Chart
	const earningsCtx = document.getElementById('earningsChart').getContext('2d');
	let earningsData = extractLabelsAndValues(earningsSeries.today);
	const earningsChart = new Chart(earningsCtx, {
		type: 'line',
		data: {
			labels: earningsData.labels,
			datasets: [{
				label: 'Earnings ($)',
				data: earningsData.values,
				fill: false,
				borderColor: '#198754',
				backgroundColor: '#198754',
				tension: 0.3,
				pointRadius: 4,
				pointHoverRadius: 6
			}]
		},
		options: {
			scales: { y: { beginAtZero: true } },
			plugins: { legend: { display: true } }
		}
	});

	document.getElementById('earningsRange').addEventListener('change', function() {
		const val = this.value;
		const data = extractLabelsAndValues(earningsSeries[val]);
		earningsChart.data.labels = data.labels;
		earningsChart.data.datasets[0].data = data.values;
		earningsChart.update();
	});

	// Completed vs Cancelled Orders Chart
	const completedCancelledCtx = document.getElementById('completedCancelledChart').getContext('2d');
	let completedData = extractLabelsAndValues(completedSeries.today);
	let cancelledData = extractLabelsAndValues(cancelledSeries.today);
	const completedCancelledChart = new Chart(completedCancelledCtx, {
		type: 'line',
		data: {
			labels: completedData.labels,
			datasets: [
				{
					label: 'Completed Orders',
					data: completedData.values,
					fill: false,
					borderColor: '#0d6efd',
					backgroundColor: '#0d6efd',
					tension: 0.3,
					pointRadius: 4,
					pointHoverRadius: 6
				},
				{
					label: 'Cancelled Orders',
					data: cancelledData.values,
					fill: false,
					borderColor: '#dc3545',
					backgroundColor: '#dc3545',
					tension: 0.3,
					pointRadius: 4,
					pointHoverRadius: 6
				}
			]
		},
		options: {
			scales: { y: { beginAtZero: true, precision:0 } },
			plugins: { legend: { display: true } }
		}
	});

	document.getElementById('completedCancelledRange').addEventListener('change', function() {
		const val = this.value;
		const completed = extractLabelsAndValues(completedSeries[val]);
		const cancelled = extractLabelsAndValues(cancelledSeries[val]);
		completedCancelledChart.data.labels = completed.labels;
		completedCancelledChart.data.datasets[0].data = completed.values;
		completedCancelledChart.data.datasets[1].data = cancelled.values;
		completedCancelledChart.update();
	});
</script>
{% endblock %}
