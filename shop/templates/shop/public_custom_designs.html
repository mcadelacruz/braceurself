{% extends 'shop/base.html' %}
{% block content %}
<style>
    .material-section-title {
        font-family: 'Montserrat', Arial, sans-serif;
        font-weight: 700;
        color: #111;
        letter-spacing: 1px;
        margin: 2.5rem 0 1.5rem 0;
        font-size: 2.1rem;
        text-align: center;
    }
    .material-card {
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1.5px solid #eee;
        background: #fff;
        transition: box-shadow .2s, transform .2s;
    }
    .material-card:hover {
        box-shadow: 0 8px 32px 0 rgba(0,0,0,0.10);
        transform: translateY(-4px) scale(1.02);
    }
    .material-card .card-title {
        color: #111;
        font-weight: 700;
        font-size: 1.2rem;
        margin-bottom: 0.7em;
    }
    .material-card .card-body {
        padding: 2rem 1.5rem;
    }
    @media (max-width: 600px) {
        .material-section-title {
            font-size: 1.1rem !important;
            margin: 1rem 0 0.7rem 0 !important;
        }
        .row.g-4 {
            gap: 0.7rem !important;
        }
        .material-card {
            border-radius: 10px !important;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.07) !important;
        }
        .material-card .card-body {
            padding: 1rem 0.5rem !important;
        }
        .card-img-top, img {
            height: 100px !important;
        }
        canvas {
            width: 80px !important;
            height: 80px !important;
        }
    }
</style>
<div class="container">
    <div class="material-section-title">Custom Designs by Other Customers</div>
    <button type="button" class="btn btn-outline-primary mb-3" onclick="window.history.back();">Back</button>
    {% if designs %}
        <div class="row g-4">
            {% for design in designs %}
                <div class="col-md-4 mb-4">
                    <div class="material-card card h-100 text-center">
                        <div class="card-body d-flex flex-column align-items-center justify-content-center">
                            <canvas id="bracelet-preview-{{ design.id }}" width="120" height="120" style="border:1px solid #eee; background:#fff; border-radius:50%; margin-bottom:10px;"></canvas>
                            <h5 class="mb-2 card-title">{{ design.name }}</h5>
                            <div class="mb-1 text-muted" style="font-size:0.95em;">By: {{ design.customer.username }}</div>
                            <div class="d-flex justify-content-center gap-2 mt-2">
                                <a href="{% url 'bracelet_design_detail' design.id %}" class="btn btn-sm btn-outline-primary">View</a>
                                {% if can_order %}
                                    <a href="{% url 'order_custom_bracelet' design.id %}" class="btn btn-sm btn-primary">Order</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <script>
                    (function() {
                        function isLightColor(hex) {
                            if (!hex) return false;
                            hex = hex.replace('#', '');
                            if (hex.length === 3) hex = hex.split('').map(x => x + x).join('');
                            if (hex.length !== 6) return false;
                            const r = parseInt(hex.substr(0,2),16);
                            const g = parseInt(hex.substr(2,2),16);
                            const b = parseInt(hex.substr(4,2),16);
                            const luminance = 0.299*r + 0.587*g + 0.114*b;
                            return luminance > 180;
                        }
                        const beads = {{ design.beads|safe }};
                        const canvas = document.getElementById('bracelet-preview-{{ design.id }}');
                        if (!canvas) return;
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0,0,canvas.width,canvas.height);
                        const cx = canvas.width/2, cy = canvas.height/2, r = 40;
                        const n = beads.length;
                        for (let i=0; i<n; ++i) {
                            const angle = (2*Math.PI*i)/n;
                            const bx = cx + r*Math.cos(angle);
                            const by = cy + r*Math.sin(angle);
                            const bead = beads[i];
                            ctx.save();
                            ctx.translate(bx, by);
                            ctx.rotate(angle + Math.PI/2);
                            ctx.strokeStyle = "#888";
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.fillStyle = bead.color || "#888";
                            let size = bead.size === "large" ? 12 : bead.size === "medium" ? 9 : 6;
                            if (bead.shape === "circle") {
                                ctx.arc(0, 0, size, 0, 2*Math.PI);
                                ctx.fill();
                                ctx.stroke();
                            } else if (bead.shape === "square") {
                                ctx.rect(-size, -size, size*2, size*2);
                                ctx.fill();
                                ctx.stroke();
                            } else if (bead.shape === "triangle") {
                                ctx.moveTo(0, -size);
                                ctx.lineTo(size, size);
                                ctx.lineTo(-size, size);
                                ctx.closePath();
                                ctx.fill();
                                ctx.stroke();
                            } else if (bead.shape === "star") {
                                ctx.beginPath();
                                for (let j = 0; j < 5; j++) {
                                    ctx.lineTo(
                                        Math.cos((18 + j * 72) / 180 * Math.PI) * size,
                                        -Math.sin((18 + j * 72) / 180 * Math.PI) * size
                                    );
                                    ctx.lineTo(
                                        Math.cos((54 + j * 72) / 180 * Math.PI) * size * 0.5,
                                        -Math.sin((54 + j * 72) / 180 * Math.PI) * size * 0.5
                                    );
                                }
                                ctx.closePath();
                                ctx.fill();
                                ctx.stroke();
                            } else if (bead.shape === "heart") {
                                ctx.beginPath();
                                ctx.moveTo(0, size/2);
                                ctx.bezierCurveTo(size, -size/2, size/2, -size, 0, -size/3);
                                ctx.bezierCurveTo(-size/2, -size, -size, -size/2, 0, size/2);
                                ctx.closePath();
                                ctx.fill();
                                ctx.stroke();
                            } else if (bead.shape === "hexagon") {
                                ctx.beginPath();
                                for (let j = 0; j < 6; j++) {
                                    let a = Math.PI/3 * j;
                                    let x = Math.cos(a) * size;
                                    let y = Math.sin(a) * size;
                                    if (j === 0) ctx.moveTo(x, y);
                                    else ctx.lineTo(x, y);
                                }
                                ctx.closePath();
                                ctx.fill();
                                ctx.stroke();
                            } else if (bead.shape === "diamond") {
                                ctx.beginPath();
                                ctx.moveTo(0, -size);
                                ctx.lineTo(size, 0);
                                ctx.lineTo(0, size);
                                ctx.lineTo(-size, 0);
                                ctx.closePath();
                                ctx.fill();
                                ctx.stroke();
                            }
                            // Draw letter if present
                            if (bead.letter) {
                                ctx.save();
                                ctx.font = `${size*1.2}px Arial Black,Arial,sans-serif`;
                                ctx.fillStyle = isLightColor(bead.color) ? "#000" : "#fff";
                                ctx.textAlign = "center";
                                ctx.textBaseline = "middle";
                                ctx.fillText(bead.letter, 0, 0);
                                ctx.restore();
                            }
                            ctx.restore();
                        }
                    })();
                    </script>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center text-muted">No public custom designs available.</div>
    {% endif %}
</div>
{% endblock %}
