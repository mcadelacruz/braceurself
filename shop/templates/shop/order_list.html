{% extends 'shop/base.html' %}
{% load dict_get %}
{% block content %}
<h1 class="mb-4">Your Orders</h1>

<form method="get" class="row g-2 mb-3">
	<div class="col-auto">
		<input type="search" name="search" class="form-control" placeholder="Search products..." value="{{ filters.search }}">
	</div>
	<div class="col-auto">
		<select name="status" class="form-select">
			<option value="">All status</option>
			{% for v,l in status_choices %}
				<option value="{{ v }}" {% if filters.status == v %}selected{% endif %}>{{ l }}</option>
			{% endfor %}
		</select>
	</div>
	<div class="col-auto">
		<select name="cancelled" class="form-select">
			<option value="">All</option>
			<option value="no" {% if filters.cancelled == 'no' %}selected{% endif %}>Active</option>
			<option value="yes" {% if filters.cancelled == 'yes' %}selected{% endif %}>Cancelled</option>
		</select>
	</div>
	<div class="col-auto">
		<select name="sort_by" class="form-select">
			<option value="created_at" {% if filters.sort_by == 'created_at' %}selected{% endif %}>Order Date</option>
			<option value="delivered_at" {% if filters.sort_by == 'delivered_at' %}selected{% endif %}>Delivered Date</option>
		</select>
	</div>
	<div class="col-auto">
		<select name="sort_dir" class="form-select">
			<option value="desc" {% if filters.sort_dir == 'desc' %}selected{% endif %}>Descending</option>
			<option value="asc" {% if filters.sort_dir == 'asc' %}selected{% endif %}>Ascending</option>
		</select>
	</div>
	<div class="col-auto">
		<button class="btn btn-primary">Filter</button>
	</div>
</form>

{% if page_obj.object_list %}
	<div class="list-group">
		{% for order in page_obj.object_list %}
			<div class="list-group-item">
				<div class="row align-items-center">
					<div class="col-md-8 d-flex align-items-center">
						{% if order.product.image %}
							<img src="{{ order.product.image.url }}" alt="{{ order.product.name }}" style="width:80px;height:80px;object-fit:cover;" class="me-3 rounded">
						{% endif %}
						<div>
							<strong>{{ order.product.name }}</strong> (x{{ order.quantity }})<br>
							<small>Ordered: {{ order.created_at|date:"Y-m-d H:i" }}{% if order.delivered_at %} â€¢ Delivered: {{ order.delivered_at|date:"Y-m-d H:i" }}{% endif %}</small>
						</div>
					</div>
					<div class="col-md-4 text-end">
						<a href="{% url 'customer_manage_order' order.id %}" class="btn btn-sm btn-outline-primary">Manage</a>
					</div>
				</div>

				<!-- Customer manage moved to dedicated page: link above -->

			</div>
		{% endfor %}
	</div>

	<nav class="mt-3">
		<ul class="pagination">
			{% if page_obj.has_previous %}
				<li class="page-item"><a class="page-link" href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Previous</a></li>
			{% else %}
				<li class="page-item disabled"><span class="page-link">Previous</span></li>
			{% endif %}
			<li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
			{% if page_obj.has_next %}
				<li class="page-item"><a class="page-link" href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Next</a></li>
			{% else %}
				<li class="page-item disabled"><span class="page-link">Next</span></li>
			{% endif %}
		</ul>
	</nav>

{% else %}
	<p>No orders yet.</p>
{% endif %}
{% endblock %}
