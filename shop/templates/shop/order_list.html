{% extends 'shop/base.html' %}
{% load dict_get %}
{% block content %}
<h1 class="mb-4">Your Orders</h1>

<form method="get" class="row g-2 mb-3">
	<div class="col-auto">
		<input type="search" name="search" class="form-control" placeholder="Search products..." value="{{ filters.search }}">
	</div>
	<div class="col-auto">
		<select name="status" class="form-select">
			<option value="">All status</option>
			{% for v,l in status_choices %}
				<option value="{{ v }}" {% if filters.status == v %}selected{% endif %}>{{ l }}</option>
			{% endfor %}
		</select>
	</div>
	<div class="col-auto">
		<select name="cancelled" class="form-select">
			<option value="">All</option>
			<option value="no" {% if filters.cancelled == 'no' %}selected{% endif %}>Active</option>
			<option value="yes" {% if filters.cancelled == 'yes' %}selected{% endif %}>Cancelled</option>
		</select>
	</div>
	<div class="col-auto">
		<select name="sort_by" class="form-select">
			<option value="created_at" {% if filters.sort_by == 'created_at' %}selected{% endif %}>Order Date</option>
			<option value="delivered_at" {% if filters.sort_by == 'delivered_at' %}selected{% endif %}>Delivered Date</option>
		</select>
	</div>
	<div class="col-auto">
		<select name="sort_dir" class="form-select">
			<option value="desc" {% if filters.sort_dir == 'desc' %}selected{% endif %}>Descending</option>
			<option value="asc" {% if filters.sort_dir == 'asc' %}selected{% endif %}>Ascending</option>
		</select>
	</div>
	<div class="col-auto">
		<button class="btn btn-primary">Filter</button>
	</div>
</form>

{% if page_obj.object_list %}
	<div class="list-group">
		{% for order in page_obj.object_list %}
			<div class="list-group-item">
				<div class="row align-items-center">
					<div class="col-md-8 d-flex align-items-center">
						{% if order.product.image %}
							<img src="{{ order.product.image.url }}" alt="{{ order.product.name }}" style="width:80px;height:80px;object-fit:cover;" class="me-3 rounded">
						{% endif %}
						<div>
							<strong>{{ order.product.name }}</strong> (x{{ order.quantity }})<br>
							<small>Ordered: {{ order.created_at|date:"Y-m-d H:i" }}{% if order.delivered_at %} â€¢ Delivered: {{ order.delivered_at|date:"Y-m-d H:i" }}{% endif %}</small>
						</div>
					</div>
					<div class="col-md-4 text-end">
						<button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#order-details-{{ order.id }}" aria-expanded="false">Manage</button>
					</div>
				</div>

				<div class="collapse mt-3" id="order-details-{{ order.id }}">
					<div class="row">
						<div class="col-md-7">
							<p><strong>Product:</strong> {{ order.product.name }}</p>
							<p><strong>Payment:</strong> {{ order.get_payment_type_display }}</p>
							<p><strong>Status:</strong> {{ order.get_status_display }}</p>
							{% if order.done %}<span class="badge bg-success">Done</span>{% endif %}
							{% if order.cancelled %}<span class="badge bg-danger">Cancelled</span><br><strong>Reason:</strong> {{ order.cancel_reason }}{% endif %}
						</div>
						<div class="col-md-5 border-start">
							<div class="ps-3 d-flex flex-column">
								<h6 class="mb-2">Messages</h6>
								<div class="flex-grow-1 mb-2" style="min-height:120px;max-height:300px;overflow-y:auto;background:#f8f9fa;padding:8px;border-radius:6px;">
									{% for msg in order.messages.all %}
										<div class="mb-2 {% if msg.sender == user %}text-end{% endif %}">
											<small class="text-muted">{{ msg.sender.username }} ({{ msg.timestamp|date:"Y-m-d H:i" }})</small><br>
											{% if msg.text %}<span class="badge bg-secondary">{{ msg.text }}</span>{% endif %}
											{% if msg.image %}<br><img src="{{ msg.image.url }}" style="max-width:180px;max-height:180px;" class="rounded mt-1">{% endif %}
										</div>
									{% empty %}
										<span class="text-muted">No messages yet.</span>
									{% endfor %}
								</div>

								<form method="post" enctype="multipart/form-data" class="d-flex gap-2" style="align-items:center;">
									{% csrf_token %}
									<input type="text" name="text" class="form-control form-control-sm" placeholder="Type message...">
									<input type="file" name="image" class="form-control form-control-sm" style="width:120px;">
									<input type="hidden" name="order_id" value="{{ order.id }}">
									<button type="submit" class="btn btn-sm btn-outline-primary">Send</button>
								</form>
							</div>
						</div>
					</div>
				</div>

			</div>
		{% endfor %}
	</div>

	<nav class="mt-3">
		<ul class="pagination">
			{% if page_obj.has_previous %}
				<li class="page-item"><a class="page-link" href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Previous</a></li>
			{% else %}
				<li class="page-item disabled"><span class="page-link">Previous</span></li>
			{% endif %}
			<li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
			{% if page_obj.has_next %}
				<li class="page-item"><a class="page-link" href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Next</a></li>
			{% else %}
				<li class="page-item disabled"><span class="page-link">Next</span></li>
			{% endif %}
		</ul>
	</nav>

{% else %}
	<p>No orders yet.</p>
{% endif %}
{% endblock %}
