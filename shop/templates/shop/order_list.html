{% extends 'shop/base.html' %}
{% load dict_get %}
{% block content %}
<h1 class="mb-4">Your Orders</h1>
{% if orders %}
    <div class="list-group">
    {% for order in orders %}
        <div class="list-group-item">
            <div class="row align-items-center">
                <div class="col-md-7">
                    <div class="mb-2">
                        {% if order.product.image %}
                            <img src="{{ order.product.image.url }}" alt="{{ order.product.name }}"
                                 style="width:100%;max-width:100%;height:220px;object-fit:cover;display:block;" class="rounded mb-2">
                        {% else %}
                            <div class="rounded bg-light d-flex align-items-center justify-content-center mb-2"
                                 style="width:100%;height:220px;">
                                <span class="text-muted">No image</span>
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <strong>{{ order.product.name }}</strong> (x{{ order.quantity }})<br>
                        Payment: {{ order.get_payment_type_display }}<br>
                        Status: {{ order.get_status_display }}
                        {% if order.done %}
                            <span class="badge bg-success">Done</span>
                        {% endif %}
                        {% if order.cancelled %}
                            <span class="badge bg-danger">Cancelled</span><br>
                            <strong>Reason:</strong> {{ order.cancel_reason }}
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-5 border-start">
                    <div class="ps-3 d-flex flex-column h-100" style="height:100%;">
                        <h6 class="mb-2">Messages</h6>
                        <div class="flex-grow-1" style="min-height:180px;max-height:400px;overflow-y:auto;background:#f8f9fa;padding:8px;border-radius:6px;">
                            {% for msg in order.messages.all %}
                                <div class="mb-2 {% if msg.sender == user %}text-end{% endif %}">
                                    <small class="text-muted">{{ msg.sender.username }} ({{ msg.timestamp|date:"Y-m-d H:i" }})</small><br>
                                    {% if msg.text %}
                                        <span class="badge bg-secondary">{{ msg.text }}</span>
                                    {% endif %}
                                    {% if msg.image %}
                                        <br><img src="{{ msg.image.url }}" style="max-width:220px;max-height:220px;" class="rounded mt-1">
                                    {% endif %}
                                </div>
                            {% empty %}
                                <span class="text-muted">No messages yet.</span>
                            {% endfor %}
                        </div>
                        {% with msg_form=msg_forms|dict_get:order.id %}
                        <form method="post" enctype="multipart/form-data" class="mt-2 d-flex align-items-center gap-2">
                            {% csrf_token %}
                            <input type="text" name="text" class="form-control form-control-sm" placeholder="Type message...">
                            <input type="file" name="image" class="form-control form-control-sm">
                            <input type="hidden" name="order_id" value="{{ order.id }}">
                            <button type="submit" class="btn btn-sm btn-outline-primary">Send</button>
                        </form>
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
{% else %}
    <p>No orders yet.</p>
{% endif %}
{% endblock %}
