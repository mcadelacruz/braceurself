{% extends 'shop/base.html' %}
{% block content %}
<div class="card mt-4">
    <div class="card-header">
        <h4>Manage Order #{{ order.id }}</h4>
    </div>
    <div class="card-body">
        <div class="row align-items-start">
            <div class="col-md-7 d-flex flex-column align-items-center">
                {% if order.product.image %}
                    <img src="{{ order.product.image.url }}" alt="{{ order.product.name }}"
                         class="mb-3 rounded"
                         style="width:100%;max-width:100%;height:220px;object-fit:cover;display:block;">
                {% else %}
                    <div class="mb-3 rounded bg-light d-flex align-items-center justify-content-center"
                         style="width:100%;height:220px;">
                        <span class="text-muted">No image</span>
                    </div>
                {% endif %}
                <div class="w-100">
                    <p><strong>Product:</strong> {{ order.product.name }}</p>
                    {% if custom_design %}
                        <div class="row mb-2">
                            <div class="col-auto d-flex align-items-center justify-content-center">
                                <canvas id="bracelet-preview-order-seller" width="120" height="120" style="border:1px solid #eee; background:#fff; border-radius:50%;"></canvas>
                            </div>
                            <div class="col">
                                <strong>Custom Design:</strong>
                                <label for="beadDropdown{{ custom_design.id }}" class="form-label d-block mb-1">Design Details:</label>
                                <select id="beadDropdown{{ custom_design.id }}" class="form-select mb-2" size="6" style="max-width:320px; height:120px;">
                                    {% for bead in custom_design.text_form %}
                                        <option>{{ bead }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <script>
                        (function() {
                            const beads = {{ custom_design.beads|safe }};
                            const canvas = document.getElementById('bracelet-preview-order-seller');
                            if (!canvas) return;
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0,0,canvas.width,canvas.height);
                            const cx = canvas.width/2, cy = canvas.height/2, r = 40;
                            const n = beads.length;
                            for (let i=0; i<n; ++i) {
                                const angle = (2*Math.PI*i)/n;
                                const bx = cx + r*Math.cos(angle);
                                const by = cy + r*Math.sin(angle);
                                const bead = beads[i];
                                ctx.save();
                                ctx.translate(bx, by);
                                ctx.rotate(angle + Math.PI/2);
                                ctx.beginPath();
                                ctx.fillStyle = bead.color || "#888";
                                let size = bead.size === "large" ? 12 : bead.size === "medium" ? 9 : 6;
                                if (bead.shape === "circle") {
                                    ctx.arc(0, 0, size, 0, 2*Math.PI);
                                    ctx.fill();
                                } else if (bead.shape === "square") {
                                    ctx.rect(-size, -size, size*2, size*2);
                                    ctx.fill();
                                } else if (bead.shape === "triangle") {
                                    ctx.moveTo(0, -size);
                                    ctx.lineTo(size, size);
                                    ctx.lineTo(-size, size);
                                    ctx.closePath();
                                    ctx.fill();
                                }
                                ctx.restore();
                            }
                        })();
                        </script>
                    {% endif %}
                    <p><strong>Customer:</strong> {{ order.customer.username }}</p>
                    <p><strong>Quantity:</strong> {{ order.quantity }}</p>
                    <p><strong>Payment Type:</strong> {{ order.get_payment_type_display }}</p>
                    <p><strong>Status:</strong> {{ order.get_status_display }}</p>
                    {% if order.done %}
                        <span class="badge bg-success">Done</span>
                    {% endif %}
                    {% if order.cancelled %}
                        <div class="alert alert-danger mt-2"><strong>Order Cancelled</strong><br>Reason: {{ order.cancel_reason }}</div>
                    {% endif %}
                    {% if error %}
                        <div class="alert alert-danger">{{ error }}</div>
                    {% endif %}
                </div>
                <form method="post" class="w-100">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="status" class="form-label">Update Status:</label>
                        <select name="status" id="status" class="form-select" {% if order.cancelled %}disabled{% endif %}>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="mark_done" id="mark_done"
                            {% if order.status != 'delivered' or order.cancelled %}disabled{% endif %}
                            {% if order.done %}checked{% endif %}>
                        <label class="form-check-label" for="mark_done">Mark as Done</label>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="cancel_order" id="cancel_order"
                            {% if order.cancelled %}disabled checked{% endif %}>
                        <label class="form-check-label" for="cancel_order">Cancel Order</label>
                    </div>
                    <div class="mb-3">
                        <label for="cancel_reason" class="form-label">Reason for cancellation:</label>
                        <textarea name="cancel_reason" id="cancel_reason" rows="2" class="form-control"
                            {% if order.cancelled %}readonly{% endif %}>{{ order.cancel_reason }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" {% if order.cancelled %}disabled{% endif %}>Update</button>
                </form>
                <a href="{% url 'seller_dashboard' %}" class="btn btn-link mt-3">Back to Dashboard</a>
            </div>
            <div class="col-md-5 border-start d-flex flex-column" style="height:100%;">
                <div class="ps-3 d-flex flex-column h-100" style="height:100%;">
                    <h6 class="mb-2">Messages</h6>
                    <!-- Messages area (plain style, compact controls) -->
                    <style>
                    .seller-messages .messages-list {
                        min-height: 220px;
                        max-height: 400px;
                        overflow-y: auto;
                        padding: 6px;
                    }
                    .seller-messages .msg-controls {
                        display: flex;
                        width: 100%;
                        gap: 8px;
                        align-items: center;
                        margin-top: .5rem;
                    }
                    .seller-messages .msg-textbox {
                        flex: 1 1 auto;
                    }
                    .seller-messages textarea[name="text"],
                    .seller-messages input[name="text"] {
                        width: 100%;
                        height: 44px;
                        padding: .5rem .75rem;
                        font-size: 1rem;
                        border-radius: .5rem;
                        border: 1px solid #ced4da;
                        resize: none;
                        box-sizing: border-box;
                    }
                    .seller-messages .right-btns {
                        display: flex;
                        gap: 8px; /* small gap between image and send button */
                    }
                    .seller-messages .square-btn,
                    .seller-messages .custom-file-label {
                        width: 44px;
                        height: 44px;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: .5rem;
                        border: 1px solid #ced4da;
                        background: #f8f9fa;
                        cursor: pointer;
                        font-size: 1.3rem;
                        transition: background .2s;
                        padding: 0;
                    }
                    .seller-messages .custom-file-label:hover,
                    .seller-messages .square-btn:hover {
                        background: #e2e6ea;
                    }
                    .seller-messages input[type="file"] {
                        display: none;
                    }
                    .seller-messages .file-name {
                        font-size: .85rem;
                        color: #555;
                        margin-left: 6px;
                    }
                    @media (max-width: 480px) {
                        .seller-messages .msg-controls { flex-wrap: wrap; }
                        .seller-messages input[type="file"] { width: 100%; }
                        .seller-messages textarea[name="text"] { max-width: 100%; flex-basis: 60%; }
                    }
                    </style>

                    <div class="seller-messages flex-grow-1">
                        <div class="messages-list">
                            {% for msg in order.messages.all %}
                                <div class="mb-3 {% if msg.sender == user %}text-end{% endif %}">
                                    <small class="text-muted">{{ msg.sender.username }} â€¢ {{ msg.timestamp|date:"Y-m-d H:i" }}</small>
                                    {% if msg.text %}
                                        <div class="mt-1">{{ msg.text|linebreaksbr }}</div>
                                    {% endif %}
                                    {% if msg.image %}
                                        <div class="mt-2"><img src="{{ msg.image.url }}" style="max-width:220px;max-height:220px;" class="rounded"></div>
                                    {% endif %}
                                </div>
                            {% empty %}
                                <div class="text-muted">No messages yet.</div>
                            {% endfor %}
                        </div>
                        <form method="post" enctype="multipart/form-data" class="msg-controls mt-2">
                            {% csrf_token %}
                            {{ msg_form.non_field_errors }}
                            <div class="msg-textbox">
                                {{ msg_form.text }}
                                {{ msg_form.text.errors }}
                            </div>
                            <div class="right-btns">
                                <label for="seller-msg-image" class="custom-file-label" title="Attach image">
                                    <span>ðŸ“·</span>
                                </label>
                                <input type="file" name="image" id="seller-msg-image" accept="image/*"
                                    onchange="document.getElementById('seller-file-name').textContent = this.files[0] ? this.files[0].name : '';">
                                <button type="submit" name="send_message" class="square-btn btn btn-outline-primary" title="Send">
                                    <span class="bi bi-send" style="font-size:1.2em;">&#10148;</span>
                                </button>
                            </div>
                            <span id="seller-file-name" class="file-name"></span>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
