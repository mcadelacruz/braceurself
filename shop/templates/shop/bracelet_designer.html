{% extends 'shop/base.html' %}
{% block content %}
<style>
    .material-section-title {
        font-family: 'Montserrat', Arial, sans-serif;
        font-weight: 700;
        color: #111;
        letter-spacing: 1px;
        margin: 2.5rem 0 1.5rem 0;
        font-size: 2.1rem;
        text-align: center;
    }
    .material-card {
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        border: 1.5px solid #eee;
        background: #fff;
        transition: box-shadow .2s, transform .2s;
    }
    .material-card .card-body {
        padding: 2rem 1.5rem;
    }
    @media (max-width: 600px) {
        .material-section-title {
            font-size: 1.1rem !important;
            margin: 1rem 0 0.7rem 0 !important;
        }
        .row.mt-4 {
            margin-top: 0.7rem !important;
            flex-direction: column !important;
        }
        .col-md-4, .col-md-5, .col-md-3 {
            max-width: 100% !important;
            flex: 0 0 100% !important;
        }
        .d-flex.flex-row.gap-3 {
            flex-direction: column !important;
            gap: 0.7rem !important;
        }
        .bead-order-list {
            max-height: 180px !important;
            min-height: 60px !important;
            padding-left: 2px !important;
        }
        .bead-order-item {
            min-height: 24px !important;
            font-size: 0.93em !important;
        }
        .shape-btn, .color-btn {
            width: 24px !important;
            height: 24px !important;
            font-size: 0.9em !important;
        }
        .bead-order-item .btn-xs {
            height: 16px !important;
            min-width: 16px !important;
            font-size: 0.85em !important;
        }
        canvas {
            width: 180px !important;
            height: 180px !important;
        }
    }
    .shape-btn, .color-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: 2px solid #888;
        background: #fff;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3em;
        cursor: pointer;
        padding: 0;
        transition: background .15s, border-color .15s;
    }
    .shape-btn.active, .color-btn.active {
        border: 3px solid #333;
        background: #e2e6ea;
    }
    .shape-btn:focus, .color-btn:focus {
        outline: 2px solid #333;
    }
    .bead-order-item {
        background: #f8f9fa;
        border-radius: 6px;
        min-height: 32px;
        font-size: 0.97em;
        border: 1px solid #e2e6ea;
    }
    .bead-order-item .btn-xs {
        padding: 0 4px;
        height: 20px;
        min-width: 20px;
        font-size: 0.95em;
    }
    .bead-order-item.dragging {
        opacity: 0.5;
        background: #f0f0f0;
    }
    .bead-order-item.drag-over {
        border: 2px dashed #888;
    }
    .bead-order-item-canvas {
        width: 20px !important;
        height: 20px !important;
        border-radius: 50%;
        display: inline-block;
        vertical-align: middle;
    }
    @media (max-width: 600px) {
        .bead-order-item-canvas {
            width: 16px !important;
            height: 16px !important;
        }
    }
</style>
<div class="container">
    <!-- show bracelet designer title -->
    <div class="material-section-title">Design Your Bracelet</div>
    <!-- show bracelet designer form -->
    <form method="post" id="bracelet-save-form" class="mb-3">
        {% csrf_token %}
        <div class="mb-2">
            <label for="bracelet-name" class="form-label">Design Name</label>
            <input type="text" name="name" id="bracelet-name" class="form-control" required>
        </div>
        <input type="hidden" name="beads" id="bracelet-beads-json">
        <button type="submit" class="btn btn-primary mt-2">Save Design</button>
    </form>
    <div class="row mt-4">
        <!-- show shape, color, size, letter pickers -->
        <div class="col-md-4">
            <div class="d-flex flex-row gap-3">
                <!-- show shape picker -->
                <div>
                    <label class="form-label"><strong>Shape</strong></label>
                    <div id="bead-shapes" class="d-flex flex-wrap gap-2">
                        <!-- show shape buttons -->
                        <button type="button" class="bead-shape shape-btn" data-shape="circle" title="Circle">&#9679;</button>
                        <button type="button" class="bead-shape shape-btn" data-shape="square" title="Square">&#9632;</button>
                        <button type="button" class="bead-shape shape-btn" data-shape="triangle" title="Triangle">&#9650;</button>
                        <button type="button" class="bead-shape shape-btn" data-shape="star" title="Star">&#9733;</button>
                        <button type="button" class="bead-shape shape-btn" data-shape="heart" title="Heart">&#9829;</button>
                        <button type="button" class="bead-shape shape-btn" data-shape="hexagon" title="Hexagon">&#11044;</button>
                        <button type="button" class="bead-shape shape-btn" data-shape="diamond" title="Diamond">&#9670;</button>
                    </div>
                </div>
                <!-- show color picker -->
                <div>
                    <label class="form-label"><strong>Color</strong></label>
                    <div id="bead-colors" class="d-flex flex-wrap gap-2">
                        <!-- show color buttons -->
                        <button type="button" class="color-btn" data-color="#ff0000" style="background:#ff0000;"></button>
                        <button type="button" class="color-btn" data-color="#0000ff" style="background:#0000ff;"></button>
                        <button type="button" class="color-btn" data-color="#00ff00" style="background:#00ff00;"></button>
                        <button type="button" class="color-btn" data-color="#ffff00" style="background:#ffff00;"></button>
                        <button type="button" class="color-btn" data-color="#ff00ff" style="background:#ff00ff;"></button>
                        <button type="button" class="color-btn" data-color="#00ffff" style="background:#00ffff;"></button>
                        <button type="button" class="color-btn" data-color="#ffffff" style="background:#ffffff;"></button>
                        <button type="button" class="color-btn" data-color="#000000" style="background:#000000;"></button>
                        <button type="button" class="color-btn" data-color="#ffa500" style="background:#ffa500;"></button>
                        <button type="button" class="color-btn" data-color="#964B00" style="background:#964B00;"></button>
                        <button type="button" class="color-btn" data-color="#808080" style="background:#808080;"></button>
                        <button type="button" class="color-btn" data-color="#FFC0CB" style="background:#FFC0CB;"></button>
                        <button type="button" class="color-btn" data-color="#8B00FF" style="background:#8B00FF;"></button>
                        <button type="button" class="color-btn" data-color="#FFD700" style="background:#FFD700;"></button>
                        <button type="button" class="color-btn" data-color="#228B22" style="background:#228B22;"></button>
                        <button type="button" class="color-btn" data-color="#B22222" style="background:#B22222;"></button>
                    </div>
                </div>
                <!-- show size, letter, add bead controls -->
                <div class="d-flex flex-column gap-2 align-items-start justify-content-end" style="min-width:110px;">
                    <div>
                        <label class="form-label"><strong>Size</strong></label>
                        <select id="bead-size" class="form-select form-select-sm" style="width:90px;">
                            <option value="small">Small</option>
                            <option value="medium">Medium</option>
                            <option value="large">Large</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label"><strong>Letter</strong></label>
                        <input type="text" id="bead-letter" maxlength="1" class="form-control form-control-sm" style="width:60px;" placeholder="A-Z">
                    </div>
                    <button type="button" id="add-bead-btn" class="btn btn-primary mt-2" style="width:90px;">Add Bead</button>
                </div>
            </div>
        </div>
        <!-- show bracelet preview -->
        <div class="col-md-5 d-flex flex-column align-items-center">
            <h5>Bracelet Preview</h5>
            <canvas id="bracelet-canvas" width="400" height="400" style="border:1.5px solid #888; background:#fff; border-radius:50%;"></canvas>
        </div>
        <!-- show bead order list -->
        <div class="col-md-3">
            <h6>Bead Order</h6>
            <div id="bead-order-scroll" class="bead-order-list" style="overflow-y:auto; max-height:420px; min-height:120px; border-left:1px solid #eee; padding-left:6px;">
                <!-- beads will be rendered here vertically -->
            </div>
            <span id="bead-count"></span>
            <span class="text-muted ms-2">(Min: 15, Max: 25 beads)</span>
        </div>
    </div>
    <!-- show bracelet designer script -->
    <script>
    const beadShapes = document.querySelectorAll('.bead-shape');
    const colorBtns = document.querySelectorAll('.color-btn');
    const beadSizeSelect = document.getElementById('bead-size');
    const beadLetterInput = document.getElementById('bead-letter');
    const addBeadBtn = document.getElementById('add-bead-btn');
    const beadCountSpan = document.getElementById('bead-count');
    const beadOrderScroll = document.getElementById('bead-order-scroll');
    const canvas = document.getElementById('bracelet-canvas');
    const ctx = canvas.getContext('2d');
    let beads = [];
    const minBeads = 15, maxBeads = 25;

    // Selected bead options
    let selectedShape = 'circle';
    let selectedColor = '#ff0000';
    let selectedSize = 'small';
    let selectedLetter = '';

    // Shape selection
    beadShapes.forEach(btn => {
        btn.addEventListener('click', function() {
            beadShapes.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedShape = this.dataset.shape;
        });
    });
    beadShapes[0].classList.add('active');

    // Color selection
    colorBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            colorBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedColor = this.dataset.color;
        });
    });
    colorBtns[0].classList.add('active');

    // Size selection
    beadSizeSelect.addEventListener('change', function() {
        selectedSize = this.value;
    });

    // Letter input
    beadLetterInput.addEventListener('input', function() {
        selectedLetter = this.value.toUpperCase().slice(0, 1);
        this.value = selectedLetter;
    });

    // Add bead
    addBeadBtn.addEventListener('click', function() {
        if (beads.length >= maxBeads) return;
        beads.push({shape: selectedShape, color: selectedColor, size: selectedSize, letter: selectedLetter});
        updateBeadOrder();
        drawBracelet();
        beadLetterInput.value = '';
        selectedLetter = '';
    });

    // Drag and drop for bead order
    let dragSrcIdx = null;
    function handleDragStart(e) {
        dragSrcIdx = +this.dataset.idx;
        this.classList.add('dragging');
    }
    function handleDragOver(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    }
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    function handleDrop(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        const targetIdx = +this.dataset.idx;
        if (dragSrcIdx !== null && dragSrcIdx !== targetIdx) {
            const bead = beads.splice(dragSrcIdx, 1)[0];
            beads.splice(targetIdx, 0, bead);
            updateBeadOrder();
            drawBracelet();
        }
        dragSrcIdx = null;
    }
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        dragSrcIdx = null;
    }

    // Helper: returns true if color is "light"
    function isLightColor(hex) {
        if (!hex) return false;
        // Remove # if present
        hex = hex.replace('#', '');
        // Expand short hex
        if (hex.length === 3) {
            hex = hex.split('').map(x => x + x).join('');
        }
        if (hex.length !== 6) return false;
        const r = parseInt(hex.substr(0,2),16);
        const g = parseInt(hex.substr(2,2),16);
        const b = parseInt(hex.substr(4,2),16);
        // Perceived luminance formula
        const luminance = 0.299*r + 0.587*g + 0.114*b;
        return luminance > 180;
    }

    // Update bead order UI (vertical, draggable)
    function updateBeadOrder() {
        beadOrderScroll.innerHTML = '';
        beads.forEach((bead, idx) => {
            const beadDiv = document.createElement('div');
            beadDiv.className = 'bead-order-item d-flex align-items-center mb-1 py-1 px-1 rounded';
            beadDiv.setAttribute('draggable', 'true');
            beadDiv.dataset.idx = idx;
            beadDiv.style.background = "#f8f9fa";
            beadDiv.style.minHeight = "38px";
            // Determine letter color: black if bead color is light, else white
            let letterColor = isLightColor(bead.color) ? "#000" : "#fff";
            beadDiv.innerHTML = `
                <div style="width:22px;height:22px;display:flex;align-items:center;justify-content:center;position:relative;">
                    <canvas class="bead-order-item-canvas" width="20" height="20"></canvas>
                    ${bead.letter ? `<span style="position:absolute;left:0;top:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:0.9em;color:${letterColor};pointer-events:none;">${bead.letter}</span>` : ''}
                </div>
                <div class="ms-1" style="font-size:0.90em;white-space:nowrap;">
                    ${bead.shape.charAt(0).toUpperCase()+bead.shape.slice(1)}, ${bead.size}
                </div>
                <div class="ms-auto d-flex flex-row gap-1 align-items-center" style="margin-left:6px;">
                    <button type="button" class="btn btn-xs btn-outline-secondary bead-up py-0 px-1" ${idx===0?'disabled':''} title="Move Up" style="font-size:0.9em;line-height:1;">&#8593;</button>
                    <button type="button" class="btn btn-xs btn-outline-secondary bead-down py-0 px-1" ${idx===beads.length-1?'disabled':''} title="Move Down" style="font-size:0.9em;line-height:1;">&#8595;</button>
                    <button type="button" class="btn btn-xs btn-outline-danger bead-del py-0 px-1" title="Delete" style="font-size:1em;line-height:1;">&times;</button>
                </div>
            `;
            // Draw bead preview with outline
            const beadCanvas = beadDiv.querySelector('canvas');
            const bctx = beadCanvas.getContext('2d');
            bctx.clearRect(0,0,20,20);
            bctx.save();
            bctx.translate(10,10);
            bctx.strokeStyle = "#888";
            bctx.lineWidth = 2;
            bctx.fillStyle = bead.color || "#888";
            let size = bead.size === "large" ? 8 : bead.size === "medium" ? 6 : 4;
            if (bead.shape === "circle") {
                bctx.beginPath();
                bctx.arc(0, 0, size, 0, 2*Math.PI);
                bctx.fill();
                bctx.stroke();
            } else if (bead.shape === "square") {
                bctx.beginPath();
                bctx.rect(-size, -size, size*2, size*2);
                bctx.fill();
                bctx.stroke();
            } else if (bead.shape === "triangle") {
                bctx.beginPath();
                bctx.moveTo(0, -size);
                bctx.lineTo(size, size);
                bctx.lineTo(-size, size);
                bctx.closePath();
                bctx.fill();
                bctx.stroke();
            } else if (bead.shape === "star") {
                bctx.beginPath();
                for (let i = 0; i < 5; i++) {
                    bctx.lineTo(
                        Math.cos((18 + i * 72) / 180 * Math.PI) * size,
                        -Math.sin((18 + i * 72) / 180 * Math.PI) * size
                    );
                    bctx.lineTo(
                        Math.cos((54 + i * 72) / 180 * Math.PI) * size * 0.5,
                        -Math.sin((54 + i * 72) / 180 * Math.PI) * size * 0.5
                    );
                }
                bctx.closePath();
                bctx.fill();
                bctx.stroke();
            } else if (bead.shape === "heart") {
                bctx.beginPath();
                bctx.moveTo(0, size/2);
                bctx.bezierCurveTo(size, -size/2, size/2, -size, 0, -size/3);
                bctx.bezierCurveTo(-size/2, -size, -size, -size/2, 0, size/2);
                bctx.closePath();
                bctx.fill();
                bctx.stroke();
            } else if (bead.shape === "hexagon") {
                bctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    let angle = Math.PI/3 * i;
                    let x = Math.cos(angle) * size;
                    let y = Math.sin(angle) * size;
                    if (i === 0) bctx.moveTo(x, y);
                    else bctx.lineTo(x, y);
                }
                bctx.closePath();
                bctx.fill();
                bctx.stroke();
            } else if (bead.shape === "diamond") {
                bctx.beginPath();
                bctx.moveTo(0, -size);
                bctx.lineTo(size, 0);
                bctx.lineTo(0, size);
                bctx.lineTo(-size, 0);
                bctx.closePath();
                bctx.fill();
                bctx.stroke();
            }
            bctx.restore();

            // Drag events
            beadDiv.addEventListener('dragstart', handleDragStart);
            beadDiv.addEventListener('dragover', handleDragOver);
            beadDiv.addEventListener('dragleave', handleDragLeave);
            beadDiv.addEventListener('drop', handleDrop);
            beadDiv.addEventListener('dragend', handleDragEnd);

            // Up/down/delete buttons
            beadDiv.querySelector('.bead-up').onclick = () => {
                if (idx > 0) {
                    [beads[idx-1], beads[idx]] = [beads[idx], beads[idx-1]];
                    updateBeadOrder();
                    drawBracelet();
                }
            };
            beadDiv.querySelector('.bead-down').onclick = () => {
                if (idx < beads.length-1) {
                    [beads[idx+1], beads[idx]] = [beads[idx], beads[idx+1]];
                    updateBeadOrder();
                    drawBracelet();
                }
            };
            beadDiv.querySelector('.bead-del').onclick = () => {
                beads.splice(idx, 1);
                updateBeadOrder();
                drawBracelet();
            };
            beadOrderScroll.appendChild(beadDiv);
        });
        beadCountSpan.textContent = `Beads: ${beads.length}`;
    }

    // Draw bracelet preview with outline and letters
    function drawBracelet() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // Find largest bead size
        let maxBeadSize = 14;
        beads.forEach(bead => {
            let size = bead.size === "large" ? 28 : bead.size === "medium" ? 20 : 14;
            if (size > maxBeadSize) maxBeadSize = size;
        });
        // Calculate minimum circle radius so beads don't overlap
        let n = beads.length;
        let beadRadius = maxBeadSize;
        let minCircleRadius = n > 1 ? beadRadius / Math.sin(Math.PI / n) + beadRadius : 150;
        let r = Math.max(150, minCircleRadius);
        // Resize canvas if needed
        let canvasSize = Math.ceil(r * 2 + beadRadius * 2 + 20);
        canvas.width = canvasSize;
        canvas.height = canvasSize;
        const cx = canvas.width/2, cy = canvas.height/2;
        for (let i=0; i<n; ++i) {
            const angle = (2*Math.PI*i)/n;
            const bx = cx + r*Math.cos(angle);
            const by = cy + r*Math.sin(angle);
            const bead = beads[i];
            ctx.save();
            ctx.translate(bx, by);
            ctx.rotate(angle + Math.PI/2); // Orient shape along circle
            ctx.strokeStyle = "#888";
            ctx.lineWidth = 2;
            ctx.fillStyle = bead.color || "#888";
            let size = bead.size === "large" ? 28 : bead.size === "medium" ? 20 : 14;
            // Draw shape with outline
            if (bead.shape === "circle") {
                ctx.beginPath();
                ctx.arc(0, 0, size, 0, 2*Math.PI);
                ctx.fill();
                ctx.stroke();
            } else if (bead.shape === "square") {
                ctx.beginPath();
                ctx.rect(-size, -size, size*2, size*2);
                ctx.fill();
                ctx.stroke();
            } else if (bead.shape === "triangle") {
                ctx.beginPath();
                ctx.moveTo(0, -size);
                ctx.lineTo(size, size);
                ctx.lineTo(-size, size);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            } else if (bead.shape === "star") {
                ctx.beginPath();
                for (let j = 0; j < 5; j++) {
                    ctx.lineTo(
                        Math.cos((18 + j * 72) / 180 * Math.PI) * size,
                        -Math.sin((18 + j * 72) / 180 * Math.PI) * size
                    );
                    ctx.lineTo(
                        Math.cos((54 + j * 72) / 180 * Math.PI) * size * 0.5,
                        -Math.sin((54 + j * 72) / 180 * Math.PI) * size * 0.5
                    );
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            } else if (bead.shape === "heart") {
                ctx.beginPath();
                ctx.moveTo(0, size/2);
                ctx.bezierCurveTo(size, -size/2, size/2, -size, 0, -size/3);
                ctx.bezierCurveTo(-size/2, -size, -size, -size/2, 0, size/2);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            } else if (bead.shape === "hexagon") {
                ctx.beginPath();
                for (let j = 0; j < 6; j++) {
                    let a = Math.PI/3 * j;
                    let x = Math.cos(a) * size;
                    let y = Math.sin(a) * size;
                    if (j === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            } else if (bead.shape === "diamond") {
                ctx.beginPath();
                ctx.moveTo(0, -size);
                ctx.lineTo(size, 0);
                ctx.lineTo(0, size);
                ctx.lineTo(-size, 0);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
            // Draw letter if present (black if light color, else white)
            if (bead.letter) {
                ctx.save();
                ctx.font = `${size*1.2}px Arial Black,Arial,sans-serif`;
                ctx.fillStyle = isLightColor(bead.color) ? "#000" : "#fff";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(bead.letter, 0, 0);
                ctx.restore();
            }
            ctx.restore();
        }
        beadCountSpan.textContent = `Beads: ${n}`;
    }

    document.getElementById('bracelet-save-form').addEventListener('submit', function(e) {
        if (beads.length < minBeads || beads.length > maxBeads) {
            alert("Bracelet must have between 15 and 25 beads.");
            e.preventDefault();
            return false;
        }
        document.getElementById('bracelet-beads-json').value = JSON.stringify(beads);
    });

    drawBracelet();
    updateBeadOrder();
    </script>
</div>
{% endblock %}
